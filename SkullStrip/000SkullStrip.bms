### The script uses:
#-ABC
#-SegPostProcessCLP
#-ImageMath
#-ResampleVolume2
####################run ABC##############################################
# apply ABC for brain skull stripping
# run ABC
set( CORRECTED '' )
set( dilatedMASK '' )
include( 010SetUp.bms )
If( ${IS_SCALED} != TRUE )
  Include (021PrepareGeneral.bms)
EndIf( ${IS_SCALED} != TRUE )
GetParam(SUFFIX ${ABC_IMAGE_SUFFIX} 0)
GetFilename( SUFFIX ${SUFFIX} NAME_WITHOUT_EXTENSION )
#set( NB_LOOP ${NB_LOOP}-1 )

ForEach (Case ${CASES})
#  set( seq 0 1 2 )
  echo('Skullstripping '${Case} )
  MakeDirectory( ${tempDir}/${Case} )
  set ( InputSubjDir ${dir}/${INPUT_PRE_SUBDIR}/${Case}/${INPUT_POST_SUBDIR})
  set ( OutputSubjDir ${dir}/${OUTPUT_PRE_SUBDIR}/${Case})
  Include (022PrepareCases.bms)
  MakeDirectory( ${OutputSubjDir}/${PROCESS_SUBDIR} )
  ForEach( i ${seq} )
    echo ( ${i} )
    Set( ABC_Case_DIR ${tempDir}/${Case}/ABC${i} )
    MakeDirectory( ${ABC_Case_DIR} )
    if( ${Registration} == TRUE )
      Include (023CaseAlign.bms)
    EndIf( ${Registration} == TRUE )
    set (ABCfile ${ABC_Case_DIR}/${Case}.xml)
    Echo ('Generating '${Case}'.xml...')
    Include (024genABC.bms)
    Echo ('Running ABC...')
    Set (abcCmd ${ABCDIR}ABC ${ABCfile})
    Echo (${abcCmd})
    Run (output ${abcCmd})
    Echo (${output})
    ####################create and apply mask############################################
    GetFilename( CaseNoDot ${Case}${SUFFIX} NAME_WITHOUT_EXTENSION )
    set( label ${ABC_Case_DIR}/${CaseNoDot}_labels_${ABCSUFFIX}.${extension} )
    set( mask ${tempDir}/${Case}/${Case}${NEW_MASK_TAG}_orig${i}.${extension} )
    set( Cmd ${SegPostProcessCLPDIR}SegPostProcessCLP ${label} ${mask} )
    echo( ${Cmd} )
    run( output ${Cmd} )
    echo( ${output} )
    #we erode and dilate to make the mask smoother
    set( erodedMASK ${tempDir}/${Case}/${Case}${NEW_MASK_TAG}_eroded${i}.${extension} )
    set( Cmd  ${ImageMathDIR}ImageMath ${mask} -erode ${MASK_CLOSING_RADIUS},1 -outfile ${erodedMASK} )
    echo( ${Cmd} )
    run( output ${Cmd} )
    echo( ${output} )
    set( dilatedMASK ${tempDir}/${Case}/${Case}${NEW_MASK_TAG}${i}.${extension} )#we save mask in case directory
    set( Cmd ${ImageMathDIR}ImageMath ${erodedMASK} -dilate ${MASK_CLOSING_RADIUS},1 -outfile ${dilatedMASK} )
    echo( ${Cmd} )
    run( output ${Cmd} )
    echo( ${output} )
    set( CORRECTED ${ABC_Case_DIR}/${CaseNoDot}_corrected_${ABCSUFFIX}.${extension} )
  EndForEach( i ${seq} )
  set( FinalMASK ${OutputSubjDir}/${PROCESS_SUBDIR}/${Case}${NEW_MASK_TAG}.${extension} )#we save mask in case directory
  set( Cmd ${ResampleVolume2DIR}ResampleVolume2 ${dilatedMASK} ${FinalMASK} -i nn )
  run( output ${Cmd} )
  echo( ${output} )
  set( CORRECTED ${ABC_Case_DIR}/${CaseNoDot}_corrected_${ABCSUFFIX}.${extension} )
  set( CORRECTED_COPY ${OutputSubjDir}/${PROCESS_SUBDIR}/${Case}${SUFFIX}_corrected.${extension} )
  If( ${biasFieldCorrection} == TRUE )
    set( Cmd ${ResampleVolume2DIR}ResampleVolume2 ${CORRECTED} ${CORRECTED_COPY} -i nn )
    run( output ${Cmd} )
    echo( ${output} )
  EndIf( ${biasFieldCorrection} == TRUE )
  if( ${ScriptName} != '' )
    GetFilename( name ${ScriptName} NAME )
    CopyFile( ${ScriptName} ${OutputSubjDir}/${PROCESS_SUBDIR}/${name} )
    CopyFile( ${ABC_Case_DIR}/${Case}.xml ${OutputSubjDir}/${PROCESS_SUBDIR}/${Case}.xml )
  Endif( ${ScriptName} != '' )
EndForEach( ${CASES} )
