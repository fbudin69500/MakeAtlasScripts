echo('Coarse Brain Mask Creation')
If( ${INPUTTYPE} == 'DWI' || ${INPUTTYPE} == 'DTI' )
  If( ${INPUTTYPE} == 'DWI' )
    Set( image ${TEMPDIR}/${B0} )
    Set( FLAG -n 1 )
  else( ${INPUTTYPE} == 'DWI' )
    Set( FLAG -n 2 )
    if( ${REGTYPE} != 'MD' || ${GIVEN_TRANSFORM} == TRUE )
      Set( image ${TEMPDIR}/${ROOTNAME}_DTI_MD.nrrd )
      Set ( Cmd ${dtiprocessPATH} --dti_image ${DTI_DIR}/${DTImage} -m ${image} --scalar-float )
      Run ( output ${Cmd} )
      echo( ${output} )
    else( ${REGTYPE} != 'MD' || ${GIVEN_TRANSFORM} == TRUE )
      Set( image ${MOVING_IMAGE} )  
    endif( ${REGTYPE} != 'MD' || ${GIVEN_TRANSFORM} == TRUE )
  EndIf( ${INPUTTYPE} == 'DWI' )
  If( ${INPUTTYPE} == 'DWI' || ${REGTYPE} != 'MD' )
    if(${InitialTransform} != '' )
#      GetFilename( TRANSFORMEDIMAGE ${image} NAME_WITHOUT_EXTENSION )
       RegEx( TRANSFORMEDIMAGE ${image} '\.'\${Reg_Ext} REPLACE '' )
       GetFilename( TRANSFORMEDIMAGE ${TRANSFORMEDIMAGE} NAME )
      Set( TRANSFORMEDIMAGE ${TEMPDIR}/${TRANSFORMEDIMAGE}_transformed_for_mask.nrrd )
#      Set( Cmd ${ResampleVolume2PATH} ${image} ${TRANSFORMEDIMAGE} -f ${InitialTransform} -R ${TEMPDIR}/initialGrid.nrrd )
      Set( Cmd ${ResampleVolume2PATH} ${image} ${TRANSFORMEDIMAGE} -f ${InitialTransform} -R ${Grid} )
      Run( output ${Cmd} )
      echo( ${output} )
      Set( image ${TRANSFORMEDIMAGE} )
    endif(${InitialTransform} != '' )
    if( ${SCALE} == TRUE )
#      GetFilename( IMAGE_ISO_SCALED ${image} NAME_WITHOUT_EXTENSION )
      RegEx( IMAGE_ISO_SCALED ${image} '\.'\${Reg_Ext} REPLACE '' )
      GetFilename( IMAGE_ISO_SCALED ${IMAGE_ISO_SCALED} NAME )
      Set( IMAGE_ISO_SCALED ${TEMPDIR}/${IMAGE_ISO_SCALED}_forMask_iso_scale.nrrd )
      Set( ResampleCmd ${ResampleVolume2PATH} ${image} ${IMAGE_ISO_SCALED} -R ${Grid} )
      Run( output ${ResampleCmd} )
      echo( ${output} )
      Set( ImageMathCmd ${ImageMathPATH} ${IMAGE_ISO_SCALED} -changeSp 1,1,1 -outfile ${IMAGE_ISO_SCALED} -type float)
      Run( output ${ImageMathCmd} )
      echo( ${output} )
      Set( image ${IMAGE_ISO_SCALED} )
    Endif( ${SCALE} == TRUE )
  else( ${INPUTTYPE} == 'DWI' || ${REGTYPE} != 'MD' )
    Set( image ${MOVING_IMAGE} )
  EndIf( ${INPUTTYPE} == 'DWI' || ${REGTYPE} != 'MD' )
Else( ${INPUTTYPE} == 'DWI' || ${INPUTTYPE} == 'DTI' )
  Set( FLAG -n 1 )
  Set( image ${MOVING_IMAGE} )
EndIf( ${INPUTTYPE} == 'DWI' || ${INPUTTYPE} == 'DTI' )
##Quantize input image
Set( quantizedImage ${TEMPDIR}/quantized.nrrd )
Set( Cmd unu quantize -i ${image} -o ${quantizedImage} -b 16 )
Run( output ${Cmd} )
echo( ${output} )
##Compute mask
Set( Cmd ${MaskComputationPATH} ${quantizedImage} -a -o ${TEMPDIR}/${ROOTNAME}_Mask.nrrd ${FLAG} )
Run( output ${Cmd} )
echo( ${output} )
